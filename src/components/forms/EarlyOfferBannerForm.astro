---
// src/components/forms/EarlyOfferBannerForm.astro
// Early Offer Banner Form - Two-step dropdown form
// Step 1: Email (always visible)
// Step 2: First Name, Last Name, Phone (reveals on email focus/input)
// Posts to /api/lead with formType="early_offer"
---

<div class="early-offer-banner">
  <div class="early-offer-banner__content">
    <form class="early-offer-form" method="POST" action="/api/lead">
      {/* Hidden input for form type */}
      <input type="hidden" name="formType" value="early_offer" />

      {/* STEP 1: Always visible */}
      <div class="early-offer-form__step-1">
        <h3 class="early-offer-form__headline">JOIN US FEBRUARY 14 Â· GRAND OPENING</h3>
        
        <div class="early-offer-form__subtext-input-group">
          <p class="early-offer-form__subtext">Enter email for an exclusive early offer</p>
          <div class="early-offer-form__primary-input-group">
            <input
              type="email"
              name="email"
              placeholder="your@email.com"
              required
              class="early-offer-form__input early-offer-form__email-input"
              id="early-offer-email"
            />
          </div>
        </div>
      </div>

      {/* STEP 2: Hidden until email focus/input */}
      <div class="early-offer-form__step-2" id="early-offer-step-2">
        <div class="early-offer-form__secondary-inputs">
          <input
            type="text"
            name="firstName"
            placeholder="First Name"
            class="early-offer-form__input"
          />
          <input
            type="text"
            name="lastName"
            placeholder="Last Name"
            class="early-offer-form__input"
          />
          <input
            type="tel"
            name="phone"
            placeholder="Phone Number"
            class="early-offer-form__input"
          />
        </div>

        {/* Turnstile CAPTCHA - Hidden until step-2 expands */}
        <div class="early-offer-form__turnstile-cta">
          <div class="cf-turnstile" data-sitekey="re_Jaax25mD_EwCxGKPcQsD7UAVxw6GHrta8"></div>
        </div>
      </div>

      {/* CTA Button */}
      <button type="submit" class="early-offer-form__submit button button--primary">
        Unlock Offer
      </button>
    </form>
  </div>
</div>

<script>
  // Handle Step 2 reveal on email focus/input
  const emailInput = document.getElementById('early-offer-email') as HTMLInputElement | null;
  const step2 = document.getElementById('early-offer-step-2');

  if (emailInput && step2) {
    // Show Step 2 on focus
    emailInput.addEventListener('focus', () => {
      step2.classList.add('is-expanded');
    });

    // Show Step 2 if email has any value
    emailInput.addEventListener('input', () => {
      if (emailInput.value.length > 0) {
        step2.classList.add('is-expanded');
      } else {
        step2.classList.remove('is-expanded');
      }
    });

    // Collapse Step 2 if email is cleared
    emailInput.addEventListener('blur', () => {
      if (emailInput.value.length === 0) {
        step2.classList.remove('is-expanded');
      }
    });
  }
</script>

<style>
  .early-offer-banner {
    background: linear-gradient(180deg, rgba(245, 241, 233, 0.55) 0%, rgba(245, 241, 233, 0.35) 100%);
    border-top: 1px solid var(--color-gold);
    border-bottom: 1px solid var(--color-gold);
    padding: 1rem 1.5rem 0.1rem 1.5rem;
    margin-top: calc(var(--header-height) + 0.5rem);
  }

  .early-offer-banner__content {
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .early-offer-form {
    display: flex;
    flex-direction: column;
    gap: 0.05rem;
    width: 100%;
    max-width: 600px;
  }

  /* Step 1: Header and Email Input */
  .early-offer-form__step-1 {
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
    text-align: center;
  }

  .early-offer-form__header {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .early-offer-form__subtext-input-group {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: baseline;
    justify-content: center;
  }

  .early-offer-form__headline {
    font-family: var(--font-serif);
    font-size: clamp(0.875rem, 2.5vw, 1.125rem) !important;
    font-weight: 400 !important;
    letter-spacing: 0.15em !important;
    text-transform: uppercase !important;
    color: var(--color-black);
    margin: 0 !important;
    line-height: 1.1;
    display: block;
    width: 100%;
    visibility: visible;
    opacity: 1;
  }

  .early-offer-form__subtext {
    font-family: var(--font-sans);
    font-size: clamp(0.75rem, 1.6vw, 0.875rem) !important;
    font-weight: 400 !important;
    color: var(--color-gray-medium);
    margin: 0 !important;
    line-height: 1.3;
    display: inline-block;
    white-space: normal;
    visibility: visible;
    opacity: 1;
  }

  .early-offer-form__primary-input-group {
    display: inline-flex;
    justify-content: center;
  }

  .early-offer-form__email-input {
    min-width: 180px;
    width: 100%;
    max-width: 240px;
  }

  /* Input Styles */
  .early-offer-form__input {
    padding: 0.55rem 0.875rem;
    font-family: var(--font-sans);
    font-size: 0.875rem;
    border: 1px solid var(--color-gold);
    border-radius: 2px;
    background-color: white;
    color: var(--color-black);
    transition: all var(--transition-fast);
    height: auto;
  }

  .early-offer-form__input::placeholder {
    color: var(--color-gray-light);
  }

  .early-offer-form__input:focus {
    outline: none;
    border-color: var(--color-black);
    box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
  }

  /* Step 2: Secondary Inputs (Hidden by default) */
  .early-offer-form__step-2 {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height var(--transition-normal), opacity var(--transition-normal);
    pointer-events: none;
  }

  .early-offer-form__step-2.is-expanded {
    max-height: 300px;
    opacity: 1;
    pointer-events: auto;
  }

  .early-offer-form__secondary-inputs {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Submit Button */
  .early-offer-form__submit {
    margin-top: 0;
    width: 100%;
    max-width: 280px;
    align-self: center;
  }

  /* Turnstile Wrapper - Minimal styling */
  .early-offer-form__turnstile-cta {
    display: flex;
    justify-content: center;
    margin-top: 0.25rem;
  }

  :global(.early-offer-form .cf-turnstile) {
    display: flex;
  }

  /* Responsive: Tablet and up */
  @media (min-width: 640px) {
    .early-offer-banner {
      padding: 1.125rem 2rem;
    }

    .early-offer-form {
      gap: 1.25rem;
    }

    .early-offer-form__subtext-input-group {
      display: flex;
      flex-direction: row;
      gap: 0.75rem;
      align-items: baseline;
      justify-content: center;
    }

    .early-offer-form__primary-input-group {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
    }

    .early-offer-form__email-input {
      max-width: 320px;
    }

    .early-offer-form__secondary-inputs {
      display: flex;
      flex-direction: row;
      gap: 0.75rem;
    }

    .early-offer-form__input:not(.early-offer-form__email-input) {
      flex: 1;
      min-width: 100px;
    }

    .early-offer-form__submit {
      max-width: 280px;
    }
  }

  @media (min-width: 1024px) {
    .early-offer-banner {
      padding: 2.25rem 3rem;
    }

    .early-offer-form__headline {
      font-size: clamp(1rem, 2.5vw, 1.3rem);
    }

    .early-offer-form__subtext {
      font-size: clamp(0.9rem, 1.9vw, 1rem);
    }
  }
</style>

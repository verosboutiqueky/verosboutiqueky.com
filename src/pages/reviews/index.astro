---
import BaseLayout from '../../layouts/BaseLayout.astro';
const BUSINESS_NAME = "VERO'S BOUTIQUE KY";
const title = `Share Your Feedback & Leave a Review - ${BUSINESS_NAME}`;
const description =
  "Help us improve by sharing your feedback. Leave a public review on Google or Facebook, or send us private feedback so we can serve you even better.";
const siteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY ?? "0x4AAAAAACWIZrFF9GFEC74s";

const GOOGLE_REVIEW_URL = 'https://g.page/r/CTrfz6CydVxVEBM/review';
const FACEBOOK_REVIEW_URL = 'https://www.facebook.com/verosboutiqueky/reviews';
---

<BaseLayout title={title} description={description}>
  <!-- HERO SECTION -->
  <section class="hero-reviews">
    <!-- Subtle Background Pattern -->
    <div class="hero-reviews__pattern"></div>

    <!-- Hero Content -->
    <div class="hero-reviews__content">
      <p class="hero-reviews__badge">
        <span class="hero-reviews__badge-dot"></span>
        Your Feedback Matters
      </p>

      <h1 class="hero-reviews__headline">
        Help Us Improve
      </h1>

      <p class="hero-reviews__subheading">
        Whether you loved your visit or think we can do better, we genuinely value your honest feedback.
        Your input helps other shoppers and helps us grow.
      </p>
    </div>
  </section>

  <!-- REVIEW SECTION -->
  <section class="section-spacing bg-ivory">
    <div class="container">
      <!-- Rating Prompt -->
      <div class="reviews-prompt">
        <h2 class="reviews-prompt__heading">How was your experience?</h2>
        <p class="reviews-prompt__subheading">Rate your experience with {BUSINESS_NAME}</p>
      </div>

      <!-- Star Rating Component -->
      <div class="reviews-star-wrapper">
        <div class="star-rating" id="star-rating-container">
          {[1, 2, 3, 4, 5].map((rating) => (
            <button
              class="star-button"
              data-rating={rating}
              aria-label={`Rate ${rating} out of 5 stars`}
              type="button"
            >
              <svg
                class="star-button__icon"
                data-rating={rating}
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="0.5"
              >
                <path
                  fill="currentColor"
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                />
              </svg>
            </button>
          ))}
        </div>
      </div>

      <!-- High Rating Response (4-5 stars) -->
      <div id="high-rating-response" class="hidden animate-fade-in">
        <div class="response-box response-box--positive">
          <div class="response-box__icon response-box__icon--positive">
            <svg class="response-icon" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
              />
            </svg>
          </div>

          <h3 class="response-box__heading">Thank you so much!</h3>
          <p class="response-box__text">
            Your kind words mean a lot to us. Would you mind sharing your experience publicly?
            It helps other shoppers feel confident and helps our boutique grow.
          </p>

          <!-- Optional: Brief Feedback Suggestion -->
          <div class="response-box__tip">
            <p class="text-sm text-text-muted">
              üí° <strong>Tip:</strong> You can mention what stood out (e.g., "Amazing selection," "Helpful styling," "Perfect fit," "Great experience.")
            </p>
          </div>

          <!-- Google & Facebook Review Buttons -->
          <div class="review-buttons">
            <button
              type="button"
              id="review-google-btn"
              data-review-url={GOOGLE_REVIEW_URL}
              class="review-button review-button--google"
            >
              <svg class="review-button__icon" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="10" fill="#4285F4" />
              </svg>
              <span class="review-button__text review-button__text--blue">Google</span>
              <span class="review-button__text review-button__text--red">Reviews</span>
              <svg class="review-button__arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>

            <button
              type="button"
              id="review-facebook-btn"
              data-review-url={FACEBOOK_REVIEW_URL}
              class="review-button review-button--facebook"
            >
              <svg class="review-button__icon" fill="#1877F2" viewBox="0 0 24 24">
                <path
                  d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"
                />
              </svg>
              <span class="review-button__text" style="color: #1877F2;">Facebook</span>
              <span class="review-button__text" style="color: #1877F2;">Reviews</span>
              <svg class="review-button__arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>

          <!-- Redirect Disclaimer -->
          <p class="response-box__disclaimer">
            ‚ÑπÔ∏è You'll be taken to Google or Facebook to complete your review. Thank you for taking the time to support {BUSINESS_NAME}!
          </p>
        </div>
      </div>

      <!-- Low Rating Response (1-3 stars) -->
      <div id="low-rating-response" class="hidden animate-fade-in">
        <div class="response-box response-box--neutral">
          <div class="response-box__icon response-box__icon--neutral">
            <svg class="response-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>

          <h3 class="response-box__heading">We're sorry to hear that.</h3>
          <p class="response-box__text">
            Your feedback helps us improve. If you're open to it, tell us what happened so we can make it right.
          </p>

          <!-- Feedback Form -->
          <form id="feedback-form" class="feedback-form" method="POST" action="/api/lead">
            <input type="hidden" name="formType" value="reviews" />

            <div class="feedback-form__group">
              <label for="feedback-email" class="feedback-form__label">
                Email (optional):
              </label>
              <input
                id="feedback-email"
                type="email"
                name="email"
                placeholder="Your email"
                class="feedback-form__input"
              />
            </div>

            <div class="feedback-form__group">
              <label for="feedback-name" class="feedback-form__label">
                Name (optional):
              </label>
              <input
                id="feedback-name"
                type="text"
                name="name"
                placeholder="Your name"
                class="feedback-form__input"
              />
            </div>

            <div class="feedback-form__group">
              <label for="feedback-message" class="feedback-form__label">
                Tell us what happened (optional):
              </label>
              <textarea
                id="feedback-message"
                name="message"
                rows="5"
                placeholder="We'd love to hear your thoughts so we can improve..."
                class="feedback-form__textarea"
              ></textarea>
            </div>

            {/* Turnstile CAPTCHA */}
            <div class="feedback-form__group">
              <div
                data-turnstile-placeholder
                data-sitekey={siteKey}
              ></div>
            </div>

            <button
              type="submit"
              class="button button--submit"
            >
              Submit Feedback
            </button>
          </form>

          <!-- Privacy Note -->
          <p class="response-box__disclaimer">
            ‚úì Your feedback is private and will not be shared publicly. It helps our team understand how we can improve your experience.
          </p>
        </div>
      </div>

      <!-- Neutral State (before rating) -->
      <div id="neutral-state" class="text-center text-text-muted">
        <p class="text-lg">üëÜ Click a star above to get started.</p>
      </div>

      <!-- Success Message (after submission) -->
      <div id="success-message" class="hidden animate-fade-in">
        <div class="response-box response-box--success">
          <div class="response-box__icon response-box__icon--success">
            <svg class="response-icon animate-bounce" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
              />
            </svg>
          </div>

          <h3 class="response-box__heading">Thank you!</h3>
          <p class="response-box__text">
            Your feedback has been received. We truly appreciate you taking the time to help us improve.
          </p>

          <button
            type="button"
            id="share-more-btn"
            class="button button--share-more"
          >
            Share More Feedback
          </button>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Hero Section */
  .hero-reviews {
    position: relative;
    height: 20rem;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-color: var(--color-ivory);
  }

  .hero-reviews__pattern {
    position: absolute;
    inset: 0;
    opacity: 0.05;
    background-image: radial-gradient(circle at 20% 50%, currentColor 0.5px, transparent 0.5px);
    background-size: 20px 20px;
  }

  .hero-reviews__content {
    position: relative;
    z-index: 10;
    margin: 0 auto;
    max-width: 48rem;
    padding: var(--space-20) var(--space-6);
    text-align: center;
    color: var(--color-black);
  }

  .hero-reviews__badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    border-radius: 9999px;
    background-color: color-mix(in srgb, #1F2937 100%, transparent);
    backdrop-filter: blur(4px);
    padding: var(--space-2) var(--space-4);
    font-size: 0.875rem;
    font-weight: 600;
    color: white;
    border: 1px solid color-mix(in srgb, #374151 100%, transparent);
    margin-bottom: var(--space-4);
  }

  .hero-reviews__badge-dot {
    display: inline-block;
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background-color: #FBBF24;
  }

  .hero-reviews__headline {
    font-family: var(--font-serif);
    font-size: clamp(3rem, 8vw, 3.75rem);
    font-weight: 900;
    letter-spacing: -0.02em;
    margin-bottom: var(--space-6);
    color: var(--color-black);
    line-height: 1.1;
  }

  .hero-reviews__subheading {
    font-size: 1.125rem;
    line-height: 1.6;
    color: #111827;
    max-width: 56rem;
    margin: 0 auto;
  }

  /* Review Prompt */
  .reviews-prompt {
    text-align: center;
    margin-bottom: var(--space-12);
  }

  .reviews-prompt__heading {
    font-size: clamp(1.875rem, 5vw, 2rem);
    font-weight: 700;
    color: var(--color-navy-dark);
    margin-bottom: var(--space-2);
  }

  .reviews-prompt__subheading {
    font-size: 1.125rem;
    color: var(--color-text-muted, #666666);
  }

  /* Star Rating */
  .reviews-star-wrapper {
    display: flex;
    justify-content: center;
    margin-bottom: var(--space-12);
  }

  .star-rating {
    display: flex;
    gap: var(--space-4);
  }

  @media (min-width: 640px) {
    .star-rating {
      gap: var(--space-6);
    }
  }

  .star-button {
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-2);
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    color: #D1D5DB;
    transform: scale(1);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .star-button:hover,
  .star-button:focus {
    color: #FBBF24;
    transform: scale(1.2);
    outline: none;
  }

  .star-button:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
    border-radius: 2px;
  }

  .star-button.active {
    color: #FBBF24;
  }

  .star-button__icon {
    width: 3rem;
    height: 3rem;
  }

  @media (min-width: 640px) {
    .star-button__icon {
      width: 4rem;
      height: 4rem;
    }
  }

  /* Response Boxes */
  .response-box {
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
  }

  .response-box--positive {
    background: linear-gradient(135deg, #F0FDF4 0%, #A7F3D0 100%);
    border: 2px solid #86EFAC;
  }

  .response-box--neutral {
    background: linear-gradient(135deg, #F0F9FF 0%, #A5F3FC 100%);
    border: 2px solid #7DD3FC;
  }

  .response-box--success {
    background: linear-gradient(135deg, #F0FDF4 0%, #A7F3D0 100%);
    border: 2px solid #86EFAC;
  }

  .response-box__icon {
    margin-bottom: var(--space-4);
  }

  .response-icon {
    width: 4rem;
    height: 4rem;
    margin: 0 auto;
  }

  .response-box__icon--positive .response-icon {
    color: #22C55E;
  }

  .response-box__icon--neutral .response-icon {
    color: #3B82F6;
  }

  .response-box__icon--success .response-icon {
    color: #22C55E;
  }

  .response-box__heading {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--color-navy-dark);
    margin-bottom: var(--space-3);
  }

  .response-box__text {
    color: var(--color-text-muted, #666666);
    font-size: 1.125rem;
    margin-bottom: var(--space-6);
  }

  .response-box__tip {
    background-color: white;
    border-radius: 0.5rem;
    padding: var(--space-6);
    margin-bottom: var(--space-6);
    border: 1px solid #D1D5DB;
  }

  .response-box__disclaimer {
    font-size: 0.75rem;
    color: var(--color-text-muted, #666666);
    background-color: #F3F4F6;
    border-radius: 0.5rem;
    padding: var(--space-3);
    margin-top: var(--space-6);
  }

  /* Review Buttons */
  .review-buttons {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    justify-content: center;
    margin-bottom: var(--space-6);
  }

  @media (min-width: 640px) {
    .review-buttons {
      flex-direction: row;
      gap: var(--space-6);
    }
  }

  .review-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    padding: 1rem 1.5rem;
    background-color: white;
    border: 2px solid #3B82F6;
    border-radius: 0.5rem;
    font-weight: 600;
    color: var(--color-navy-dark);
    transition: all 200ms ease-out;
    text-decoration: none;
    cursor: pointer;
    font-family: var(--font-sans);
    font-size: 1rem;
  }

  .review-button:hover {
    background-color: #EFF6FF;
    transform: translateY(-2px);
  }

  .review-button:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
  }

  .review-button__icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  .review-button__text {
    font-weight: 600;
  }

  .review-button__text--blue {
    color: #1E40AF;
  }

  .review-button__text--red {
    color: #DC2626;
  }

  .review-button__arrow {
    width: 1rem;
    height: 1rem;
    margin-left: var(--space-2);
    transition: transform 200ms ease-out;
  }

  .review-button:hover .review-button__arrow {
    transform: translateX(0.25rem);
  }

  /* Feedback Form */
  .feedback-form {
    background-color: white;
    border-radius: 0.5rem;
    padding: var(--space-6);
    border: 1px solid #7DD3FC;
    margin-bottom: var(--space-6);
  }

  .feedback-form__group {
    margin-bottom: var(--space-4);
    text-align: left;
  }

  .feedback-form__label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-navy-dark);
    margin-bottom: var(--space-2);
  }

  .feedback-form__textarea {
    width: 100%;
    padding: var(--space-4);
    border: 1px solid #D1D5DB;
    border-radius: 0.5rem;
    font-family: var(--font-sans);
    font-size: 1rem;
    resize: none;
    transition: all 200ms ease-out;
  }

  .feedback-form__textarea:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    border-color: #3B82F6;
    ring-color: #3B82F6;
  }

  .feedback-form__input {
    width: 100%;
    padding: var(--space-4);
    border: 1px solid #D1D5DB;
    border-radius: 0.5rem;
    font-family: var(--font-sans);
    font-size: 1rem;
    transition: all 200ms ease-out;
  }

  .feedback-form__input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    border-color: #3B82F6;
  }

  /* Submit Button Overrides */
  .button--submit {
    width: 100%;
    background-color: #3B82F6;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    font-weight: 600;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 200ms ease-out;
  }

  .button--submit:hover {
    background-color: #2563EB;
    transform: translateY(-2px);
  }

  .button--submit:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
  }

  .button--share-more {
    padding: 0.75rem 1.5rem;
    background-color: #22C55E;
    color: white;
    border: none;
    font-weight: 600;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 200ms ease-out;
  }

  .button--share-more:hover {
    background-color: #16A34A;
  }

  .button--share-more:focus-visible {
    outline: 2px solid var(--color-gold);
    outline-offset: 2px;
  }

  /* Utility Classes */
  .bg-ivory {
    background-color: var(--color-ivory);
  }

  .text-center {
    text-align: center;
  }

  .text-lg {
    font-size: 1.125rem;
  }

  .text-sm {
    font-size: 0.875rem;
  }

  .text-text-muted {
    color: var(--color-text-muted, #666666);
  }

  @keyframes bounce {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .animate-bounce {
    animation: bounce 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* Turnstile */
  :global(.cf-turnstile) {
    display: flex;
    justify-content: center;
  }
</style>

<script is:inline>
  // Star Rating Interaction Handler
  const starButtons = document.querySelectorAll('.star-button');
  const highRatingResponse = document.getElementById('high-rating-response');
  const lowRatingResponse = document.getElementById('low-rating-response');
  const neutralState = document.getElementById('neutral-state');
  const successMessage = document.getElementById('success-message');
  const feedbackForm = document.getElementById('feedback-form');
  const shareMoreBtn = document.getElementById('share-more-btn');
  const googleBtn = document.getElementById('review-google-btn');
  const facebookBtn = document.getElementById('review-facebook-btn');

  let currentRating = 0;
  let redirectInProgress = false;

  // Google Review URL from frontmatter
  const GOOGLE_REVIEW_URL = 'https://g.page/r/CTrfz6CydVxVEBM/review';

  function updateStarDisplay(rating) {
    starButtons.forEach((btn) => {
      const btnRating = parseInt(btn.getAttribute('data-rating') || '0', 10);
      if (btnRating <= rating) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  // Show "Redirecting..." toast for immediate Google redirect
  function showRedirectingToast() {
    let toast = document.getElementById('redirecting-toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'redirecting-toast';
      toast.style.cssText = `
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        z-index: 9999;
        font-size: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      `;
      document.body.appendChild(toast);
    }
    toast.textContent = 'Redirecting to Google Reviews...';
    toast.style.display = 'block';
    return toast;
  }

  // Fire GA4 event for review redirect tracking
  function fireReviewRedirectEvent(rating) {
    if (window.gtag) {
      window.gtag('event', 'review_redirect', {
        rating: rating.toString(),
        destination: 'google',
      });
    }
  }

  function showResponse(rating) {
    currentRating = rating;

    // Hide all responses
    neutralState?.classList.add('hidden');
    highRatingResponse?.classList.add('hidden');
    lowRatingResponse?.classList.add('hidden');
    successMessage?.classList.add('hidden');

    // Show appropriate response
    if (rating >= 4) {
      highRatingResponse?.classList.remove('hidden');
    } else if (rating >= 1) {
      lowRatingResponse?.classList.remove('hidden');
      feedbackForm?.reset();
      // Load Turnstile for the low-rating form
      if (window.loadTurnstile) {
        window.loadTurnstile();
      }
    }
  }

  // Click + keyboard handlers to stars
  starButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      if (redirectInProgress) return;

      const rating = parseInt(btn.getAttribute('data-rating') || '0', 10);
      updateStarDisplay(rating);

      // For 4-5‚òÖ: Immediate redirect to Google
      if (rating >= 4) {
        redirectInProgress = true;
        showRedirectingToast();
        fireReviewRedirectEvent(rating);

        // Wait 300ms for toast visibility + analytics, then redirect
        setTimeout(() => {
          window.location.href = GOOGLE_REVIEW_URL;
        }, 300);
      } else {
        // For 1-3‚òÖ: Show feedback form (existing behavior)
        showResponse(rating);
      }
    });

    btn.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const rating = parseInt(btn.getAttribute('data-rating') || '0', 10);
        updateStarDisplay(rating);

        // For 4-5‚òÖ: Immediate redirect to Google
        if (rating >= 4) {
          if (redirectInProgress) return;
          redirectInProgress = true;
          showRedirectingToast();
          fireReviewRedirectEvent(rating);

          // Wait 300ms for toast visibility + analytics, then redirect
          setTimeout(() => {
            window.location.href = GOOGLE_REVIEW_URL;
          }, 300);
        } else {
          // For 1-3‚òÖ: Show feedback form (existing behavior)
          showResponse(rating);
        }
      }
    });
  });

  // "Share More Feedback"
  shareMoreBtn?.addEventListener('click', () => location.reload());

  // Low-rating form submission (posts to /api/lead via form action)
  // The form's native POST with Turnstile will handle it

  // High-rating review button handlers are now obsolete (users are redirected immediately on star click)
  // These remain for backwards compatibility but should not be reached
  async function submitReviewEvent(rating, source) {
    try {
      const formData = new FormData();
      formData.set('formType', 'reviews');
      formData.set('rating', rating.toString());
      formData.set('source', source);
      // Get Turnstile token if available (optional for high-rating tracking)
      const turnstileToken = window.turnstile?.getResponse?.();
      if (turnstileToken) {
        formData.set('cf-turnstile-response', turnstileToken);
      }

      // Fire request but don't wait for it
      fetch('/api/lead', {
        method: 'POST',
        body: formData,
      }).catch(() => {});
    } catch (e) {
      // Silently fail on high-rating submissions (background task)
    }
  }

  googleBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    submitReviewEvent(currentRating, 'google');
    // Immediately redirect
    setTimeout(() => {
      window.open(googleBtn.dataset.reviewUrl, '_blank');
    }, 50);
  });

  facebookBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    submitReviewEvent(currentRating, 'facebook');
    // Immediately redirect
    setTimeout(() => {
      window.open(facebookBtn.dataset.reviewUrl, '_blank');
    }, 50);
  });
</script>
